#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –±—ç–∫–∞–ø–æ–≤

# –ü–æ–ª—É—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="$(dirname "$SCRIPT_DIR")"
BACKUP_DIR="$BACKEND_DIR/backups"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –±—ç–∫–∞–ø–∞–º–∏
if [ ! -d "$BACKUP_DIR" ]; then
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –±—ç–∫–∞–ø–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $BACKUP_DIR"
    exit 1
fi

# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—ç–∫–∞–ø–æ–≤ (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
BACKUP_COUNT=$(ls -1 "$BACKUP_DIR"/*.sql.gz "$BACKUP_DIR"/*.sql.sqlite.gz 2>/dev/null | wc -l)

if [ $BACKUP_COUNT -eq 0 ]; then
    echo "üì≠ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤"
    exit 0
fi

echo "üì¶ –í—Å–µ–≥–æ –±—ç–∫–∞–ø–æ–≤: $BACKUP_COUNT"
echo ""
echo "üìã –°–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤ (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º):"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤ (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
ls -lht "$BACKUP_DIR"/*.sql.gz "$BACKUP_DIR"/*.sql.sqlite.gz 2>/dev/null | awk '{
    size = $5
    date = $6 " " $7 " " $8
    filename = $9
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ –ø—É—Ç–∏
    split(filename, parts, "/")
    name = parts[length(parts)]
    printf "  %-50s %8s  %s\n", name, size, date
}'

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø –æ—Ç–¥–µ–ª—å–Ω–æ
echo ""
echo "üîπ –ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø:"
LATEST=$(ls -t "$BACKUP_DIR"/*.sql.gz "$BACKUP_DIR"/*.sql.sqlite.gz 2>/dev/null | head -1)
if [ ! -z "$LATEST" ]; then
    LATEST_SIZE=$(du -h "$LATEST" | cut -f1)
    LATEST_DATE=$(stat -c %y "$LATEST" 2>/dev/null || stat -f "%Sm" "$LATEST")
    echo "   –§–∞–π–ª: $(basename $LATEST)"
    echo "   –†–∞–∑–º–µ—Ä: $LATEST_SIZE"
    echo "   –î–∞—Ç–∞: $LATEST_DATE"
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –≤—Å–µ—Ö –±—ç–∫–∞–ø–æ–≤
TOTAL_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
echo ""
echo "üíæ –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –≤—Å–µ—Ö –±—ç–∫–∞–ø–æ–≤: $TOTAL_SIZE"
