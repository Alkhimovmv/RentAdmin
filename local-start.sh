#!/bin/bash

# –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ RentAdmin –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —Å –ª—é–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ —Å–µ—Ç–∏

echo "üè† –ó–∞–ø—É—Å–∫ RentAdmin - –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä"
echo "====================================="
echo ""

# –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π IP
LOCAL_IP=$(hostname -I | awk '{print $1}')
echo "üìç –í–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π IP: $LOCAL_IP"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pkill -f local-server 2>/dev/null || true
pkill -f simple-frontend 2>/dev/null || true
lsof -ti:3000 | xargs -r kill 2>/dev/null || true

# –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ ! -d "$HOME/rentadmin-deploy/www" ]; then
    echo "üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
    ./scripts/simple-deploy.sh > /dev/null 2>&1
    echo "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
echo "üöÄ –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞..."
nohup node local-server.js > local-server.log 2>&1 &
SERVER_PID=$!
echo $SERVER_PID > local-server.pid

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—Å–∫
if curl -s http://localhost:3000/health > /dev/null; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f local-server.log"
    exit 1
fi

echo ""
echo "üéâ RentAdmin –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏!"
echo ""
echo "üåê –î–û–°–¢–£–ü –ö –°–ï–†–í–ï–†–£:"
echo "üìç –° —ç—Ç–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞:  http://localhost:3000/"
echo "üìç –ò–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏:   http://$LOCAL_IP:3000/"
echo "üì± –° —Ç–µ–ª–µ—Ñ–æ–Ω–∞:          http://$LOCAL_IP:3000/"
echo ""
echo "üìã –ò–ù–§–û–†–ú–ê–¶–ò–Ø:"
echo "‚ÑπÔ∏è  –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞:      http://$LOCAL_IP:3000/info"
echo "‚ù§Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è:   http://$LOCAL_IP:3000/health"
echo "üß™ –î–µ–º–æ API:             http://$LOCAL_IP:3000/api/demo"
echo ""
echo "üì± –î–õ–Ø –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –° –î–†–£–ì–ò–• –£–°–¢–†–û–ô–°–¢–í:"
echo "1Ô∏è‚É£  –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∫ —Ç–æ–π –∂–µ WiFi —Å–µ—Ç–∏"
echo "2Ô∏è‚É£  –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ"
echo "3Ô∏è‚É£  –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –∞–¥—Ä–µ—Å—É: http://$LOCAL_IP:3000/"
echo ""
echo "üí° –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û:"
echo "üîß –ó–∞–ø—É—Å–∫ backend:       cd backend && npm start"
echo "üìã –õ–æ–≥–∏:                 tail -f local-server.log"
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞:            kill \$(cat local-server.pid)"
echo ""
echo "üî• –°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º QR –∫–æ–¥ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å qrencode)
if command -v qrencode &> /dev/null; then
    echo ""
    echo "üì± QR –∫–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞:"
    echo "http://$LOCAL_IP:3000/" | qrencode -t UTF8
fi