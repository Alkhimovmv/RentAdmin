#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ RentAdmin"
echo "=================="

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è PID –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
PIDS=()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
cleanup() {
    echo -e "\n${RED}üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...${NC}"
    for pid in "${PIDS[@]}"; do
        if kill -0 "$pid" 2>/dev/null; then
            echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ $pid"
            kill "$pid" 2>/dev/null
        fi
    done
    exit 0
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤
trap cleanup SIGINT SIGTERM

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Node.js
if ! command -v node &> /dev/null; then
    echo -e "${RED}‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ npm
if ! command -v npm &> /dev/null; then
    echo -e "${RED}‚ùå npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    exit 1
fi

echo -e "${BLUE}üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ backend
if [ ! -d "backend/node_modules" ]; then
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend..."
    cd backend && npm install
    cd ..
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ frontend
if [ ! -d "frontend/node_modules" ]; then
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend..."
    cd frontend && npm install
    cd ..
fi

# –°–æ–±–∏—Ä–∞–µ–º backend
echo -e "${BLUE}üî® –°–±–æ—Ä–∫–∞ backend...${NC}"
cd backend && npm run build
cd ..

# –ó–∞–ø—É—Å–∫–∞–µ–º backend
echo -e "${GREEN}üü¢ –ó–∞–ø—É—Å–∫ Backend –Ω–∞ –ø–æ—Ä—Ç—É 3001...${NC}"
cd backend
NODE_ENV=development PORT=3001 JWT_SECRET=super-secret-jwt-key-for-rent-admin-2024 PIN_CODE=20031997 CORS_ORIGIN="*" npm start &
BACKEND_PID=$!
PIDS+=($BACKEND_PID)
cd ..

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ backend
echo "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ backend..."
sleep 5

# –ó–∞–ø—É—Å–∫–∞–µ–º frontend
echo -e "${GREEN}üü° –ó–∞–ø—É—Å–∫ Frontend –Ω–∞ –ø–æ—Ä—Ç—É 5174...${NC}"
cd frontend
VITE_API_URL=http://localhost:3001/api PORT=5174 npm run dev &
FRONTEND_PID=$!
PIDS+=($FRONTEND_PID)
cd ..

echo ""
echo -e "${GREEN}‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!${NC}"
echo "üìç Frontend: http://localhost:5174"
echo "üìç Backend API: http://localhost:3001/api"
echo "üìç Health check: http://localhost:3001/api/health"
echo ""
echo "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
wait