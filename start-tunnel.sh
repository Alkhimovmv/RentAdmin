#!/bin/bash

# –ó–∞–ø—É—Å–∫ RentAdmin —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º —á–µ—Ä–µ–∑ localtunnel (–±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)

echo "üåç –ó–∞–ø—É—Å–∫ RentAdmin —Å –ø—É–±–ª–∏—á–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º (localtunnel)"
echo "=================================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
if ! curl -s http://localhost:3000/health > /dev/null; then
    echo "‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å–∫–∞—é..."
    ./local-start.sh
    sleep 5

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑
    if ! curl -s http://localhost:3000/health > /dev/null; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä"
        echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ./local-start.sh"
        exit 1
    fi
fi

echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º localtunnel
if [ ! -f "node_modules/.bin/lt" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é localtunnel..."
    npm install localtunnel
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—É–Ω–Ω–µ–ª–∏
pkill -f "node.*localtunnel" 2>/dev/null || true
pkill -f "lt " 2>/dev/null || true

echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –ø—É–±–ª–∏—á–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å..."
echo "‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-20 —Å–µ–∫—É–Ω–¥..."

# –ó–∞–ø—É—Å–∫–∞–µ–º localtunnel –≤ —Ñ–æ–Ω–µ
nohup ./node_modules/.bin/lt --port 3000 > tunnel.log 2>&1 &
TUNNEL_PID=$!
echo $TUNNEL_PID > tunnel.pid

# –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è URL –≤ –ª–æ–≥–∞—Ö
echo "‚è≥ –ñ–¥–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL..."
PUBLIC_URL=""

for i in {1..30}; do
    if [ -f tunnel.log ]; then
        # –ò—â–µ–º URL –≤ –ª–æ–≥–∞—Ö
        PUBLIC_URL=$(grep -o 'https://.*\.loca\.lt' tunnel.log 2>/dev/null | head -1)
        if [ ! -z "$PUBLIC_URL" ]; then
            break
        fi
    fi
    sleep 1
    echo -n "."
done

echo ""

if [ -z "$PUBLIC_URL" ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π URL"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f tunnel.log"
    echo "–í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º"
    exit 1
fi

echo ""
echo "üéâ RentAdmin –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –º–∏—Ä–∞!"
echo ""
echo "üåç –ü–£–ë–õ–ò–ß–ù–´–ô –î–û–°–¢–£–ü:"
echo "üîó URL: $PUBLIC_URL"
echo "üì± –° —Ç–µ–ª–µ—Ñ–æ–Ω–∞: $PUBLIC_URL"
echo "üíª –° –ª—é–±–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞: $PUBLIC_URL"
echo ""
echo "üìã –õ–û–ö–ê–õ–¨–ù–´–ô –î–û–°–¢–£–ü (–∫–∞–∫ —Ä–∞–Ω—å—à–µ):"
echo "üè† –õ–æ–∫–∞–ª—å–Ω–æ: http://localhost:3000/"
echo "üì∂ –í —Å–µ—Ç–∏: http://$(hostname -I | awk '{print $1}'):3000/"
echo ""
echo "üîß –£–ü–†–ê–í–õ–ï–ù–ò–ï:"
echo "üìã –õ–æ–≥–∏ —Ç—É–Ω–Ω–µ–ª—è: tail -f tunnel.log"
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞: kill \$(cat tunnel.pid)"
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: ./start-tunnel.sh"
echo ""
echo "üí° –í–ê–ñ–ù–û:"
echo "‚ö†Ô∏è –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ localtunnel"
echo "   –ù–∞–∂–º–∏—Ç–µ 'Click to Continue' –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è"
echo "‚ö†Ô∏è URL –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –∑–∞–ø—É—â–µ–Ω —Ç—É–Ω–Ω–µ–ª—å"
echo "‚ö†Ô∏è –î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Cloudflare Tunnel"
echo ""
echo "üéä –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å URL —Å –∫–µ–º —É–≥–æ–¥–Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é!"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º QR –∫–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å qrencode
if command -v qrencode &> /dev/null; then
    echo ""
    echo "üì± QR –∫–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:"
    echo "$PUBLIC_URL" | qrencode -t UTF8
fi

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..."
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
if curl -s --max-time 10 "$PUBLIC_URL/health" > /dev/null; then
    echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
else
    echo "‚ö†Ô∏è –¢—É–Ω–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å $PUBLIC_URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
fi